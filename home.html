<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>GameBox</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  EmailAuthProvider,
  reauthenticateWithCredential
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDulFQbzyizMXE1i7uBD5RVaR6bQa0SEfU",
  authDomain: "gamebox-681ef.firebaseapp.com",
  projectId: "gamebox-681ef"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user, data;

onAuthStateChanged(auth, async (u) => {
  if (!u) return location.href = "index.html";
  user = u;

  const ref = doc(db, "users", u.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(ref, {
      username: "user" + Math.floor(10000 + Math.random() * 90000),
      ageStatus: "<13",
      ageChecked: false,
      lastUsernameChange: 0
    });
    location.reload();
    return;
  }

  data = snap.data();
  render();
});

function render() {
  username.textContent = data.username;
  ageBadge.textContent = data.ageStatus;

  if (data.ageChecked) ageBanner.style.display = "none";
}

window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};

// AGE CHECK FLOW
window.startAgeCheck = () => {
  step1.style.display = "none";
  step2.style.display = "block";
};

window.submitAge = async () => {
  if (!confirmAge.checked) return alert("Bitte bestätigen");
  const birth = new Date(birthdate.value);
  const age = (Date.now() - birth) / 31557600000;

  if (age < 5 || age > 100) {
    alert("Ungültiges Alter");
    return;
  }

  const status = age >= 13 ? "13+" : "<13";

  await updateDoc(doc(db, "users", user.uid), {
    ageStatus: status,
    ageChecked: true,
    ageVerifiedAt: serverTimestamp()
  });

  data.ageChecked = true;
  data.ageStatus = status;
  ageModal.style.display = "none";
  render();
};
</script>

<style>
:root {
  --bg: #0f0f14;
  --glass: rgba(255,255,255,.08);
  --border: rgba(255,255,255,.15);
  --accent: #6366f1;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Inter, sans-serif;
  background: radial-gradient(circle at top, #1a1a2e, var(--bg));
  color: white;
  display: flex;
}

/* SIDEBAR */
.sidebar {
  width: 240px;
  padding: 20px;
  background: var(--glass);
  backdrop-filter: blur(14px);
  border-right: 1px solid var(--border);
}
.sidebar img {
  width: 100%;
  margin-bottom: 30px;
}
.nav button {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  background: transparent;
  border: 1px solid var(--border);
  color: white;
  border-radius: 12px;
}
.nav .premium {
  background: linear-gradient(135deg, gold, orange);
  color: black;
  font-weight: 700;
}

/* MAIN */
.main { flex: 1; }

/* TOPBAR */
.topbar {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 30px;
  background: var(--glass);
  backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--border);
}
.search {
  margin: auto;
  padding: 8px 14px;
  border-radius: 20px;
  border: none;
  background: #1f1f2f;
  color: white;
}
.userbox {
  display: flex;
  align-items: center;
  gap: 8px;
}
.badge {
  background: #27273a;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 12px;
}

/* MODALS */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
}
.card {
  width: 420px;
  padding: 24px;
  background: var(--glass);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  border: 1px solid var(--border);
}

/* AGE BANNER */
.age-banner {
  background: linear-gradient(135deg, #7c3aed, #6366f1);
  padding: 12px;
  border-radius: 14px;
  margin: 20px;
}
</style>
</head>

<body>

<div class="sidebar">
  <img src="gamebox_logo1.png">
  <div class="nav">
    <button>Homepage</button>
    <button>Profile</button>
    <button>Shop</button>
    <button class="premium">Premium</button>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <input class="search" placeholder="Search...">
    <div class="userbox">
      <span id="username"></span>
      <span class="badge" id="ageBadge"></span>
      <button onclick="settings.style.display='flex'">⋯</button>
    </div>
  </div>

  <div class="age-banner" id="ageBanner">
    Age verification required
    <button onclick="ageModal.style.display='flex'">Continue</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="modal" id="settings">
  <div class="card">
    <h2>Settings</h2>
    <button onclick="logout()">Logout</button>
    <button onclick="settings.style.display='none'">Close</button>
  </div>
</div>

<!-- AGE CHECK -->
<div class="modal" id="ageModal">
  <div class="card">
    <div id="step1">
      <h3>Age Verification</h3>
      <p>We must verify your age to comply with regulations.</p>
      <button onclick="startAgeCheck()">Continue</button>
    </div>

    <div id="step2" style="display:none;">
      <input type="date" id="birthdate">
      <label>
        <input type="checkbox" id="confirmAge">
        I confirm this is correct
      </label>
      <button onclick="submitAge()">Verify</button>
    </div>
  </div>
</div>

</body>
</html>
