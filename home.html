<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>GameBox</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  EmailAuthProvider,
  reauthenticateWithCredential
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDulFQbzyizMXE1i7uBD5RVaR6bQa0SEfU",
  authDomain: "gamebox-681ef.firebaseapp.com",
  projectId: "gamebox-681ef"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user, data;

/* AUTH */
onAuthStateChanged(auth, async (u) => {
  if (!u) return location.href = "index.html";
  user = u;

  const ref = doc(db, "users", u.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(ref, {
      username: "user" + Math.floor(10000 + Math.random() * 90000),
      ageStatus: "<13",
      ageChecked: false,
      premium: false,
      theme: "dark",
      lastUsernameChange: 0,
      createdAt: serverTimestamp()
    });
    location.reload();
    return;
  }

  data = snap.data();

  // ADMIN OVERRIDE
  if (user.email === "crafiii60@gmail.com") {
    await updateDoc(ref, { ageStatus: "13+", ageChecked: true });
    data.ageStatus = "13+";
    data.ageChecked = true;
  }

  applyTheme();
  render();
});

/* RENDER */
function render() {
  username.textContent = data.username;
  ageBadge.textContent = data.ageStatus;

  profileUsername.textContent = data.username;
  profileAge.textContent = data.ageStatus;
  profileVerified.textContent = data.ageChecked ? "Yes" : "No";
  profileUID.textContent = user.uid;
  profileCreated.textContent = user.metadata.creationTime;
  profileProvider.textContent = user.providerData[0]?.providerId;
  profilePremium.textContent = data.premium ? "Active ⭐" : "No";
  profileTheme.textContent = data.theme;
  profileLastName.textContent = data.lastUsernameChange
    ? new Date(data.lastUsernameChange).toLocaleDateString()
    : "Never";

  settingsTheme.value = data.theme;
  premiumBtn.textContent = data.premium ? "Premium Active ⭐" : "Upgrade to Premium";

  if (data.ageChecked) ageBanner.style.display = "none";
}

/* THEME */
function applyTheme() {
  document.body.dataset.theme = data.theme;
}
window.changeTheme = async (v) => {
  data.theme = v;
  applyTheme();
  await updateDoc(doc(db, "users", user.uid), { theme: v });
};

/* USERNAME CHANGE */
window.changeUsername = async () => {
  const newName = newUsername.value.trim();
  const pw = confirmPassword.value;
  if (!newName || !pw) return alert("Missing data");

  if (
    (newName === "Crafii9" || newName === "Crafii9YT") &&
    user.email !== "crafiii60@gmail.com"
  ) return alert("Username reserved");

  if (Date.now() - data.lastUsernameChange < 2592000000)
    return alert("Only every 30 days");

  const cred = EmailAuthProvider.credential(user.email, pw);
  await reauthenticateWithCredential(user, cred);

  await updateDoc(doc(db, "users", user.uid), {
    username: newName,
    lastUsernameChange: Date.now()
  });

  data.username = newName;
  render();
  alert("Username updated");
};

/* PREMIUM (FAKE UPGRADE) */
window.buyPremium = async () => {
  await updateDoc(doc(db, "users", user.uid), { premium: true });
  data.premium = true;
  render();
};

/* LOGOUT */
window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};

/* MODALS */
window.openSettings = () => settings.style.display = "flex";
window.openProfile = () => profile.style.display = "flex";
window.openShop = () => shop.style.display = "flex";
window.closeModal = (id) => id.style.display = "none";
</script>

<style>
:root {
  --bg: #0f0f14;
  --panel: rgba(255,255,255,.08);
  --border: rgba(255,255,255,.15);
}
body {
  margin: 0;
  font-family: Inter, sans-serif;
  background: var(--bg);
  color: white;
  display: flex;
}
body[data-theme="light"] {
  --bg: #f4f4f5;
  --panel: rgba(0,0,0,.06);
  --border: rgba(0,0,0,.12);
  color: black;
}

/* SIDEBAR */
.sidebar {
  width: 240px;
  height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 20px;
  background: var(--panel);
  border-right: 1px solid var(--border);
}
.nav { flex: 1; }
button {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
}
.premium { background: gold; color: black; }

/* MAIN */
.main { flex: 1; }

/* TOPBAR */
.topbar {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
}
.search {
  margin: auto;
  padding: 8px 14px;
}
.badge {
  font-size: 12px;
  padding: 4px 8px;
  background: #27273a;
  border-radius: 999px;
}

/* MODALS */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  justify-content: center;
  align-items: center;
}
.card {
  width: 460px;
  padding: 24px;
  background: var(--panel);
  border-radius: 20px;
}
.age-banner {
  margin: 20px;
  padding: 14px;
  background: linear-gradient(135deg, #7c3aed, #6366f1);
  border-radius: 14px;
}
</style>
</head>

<body>

<div class="sidebar">
  <img src="gamebox_logo1.png">
  <div class="nav">
    <button>Homepage</button>
    <button onclick="openProfile()">Profile</button>
    <button onclick="openShop()">Shop</button>
  </div>
  <button class="premium" id="premiumBtn" onclick="buyPremium()">Upgrade to Premium</button>
</div>

<div class="main">
  <div class="topbar">
    <input class="search" placeholder="Search">
    <span id="username"></span>
    <span class="badge" id="ageBadge"></span>
    <button onclick="openSettings()">⋯</button>
  </div>

  <div class="age-banner" id="ageBanner">Age verification required</div>
</div>

<!-- SETTINGS -->
<div class="modal" id="settings">
  <div class="card">
    <h2>Settings</h2>
    <select id="settingsTheme" onchange="changeTheme(this.value)">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>
    <input id="newUsername" placeholder="New username">
    <input id="confirmPassword" type="password" placeholder="Password">
    <button onclick="changeUsername()">Change Username</button>
    <button onclick="logout()">Logout</button>
    <button onclick="closeModal(settings)">Close</button>
  </div>
</div>

<!-- PROFILE -->
<div class="modal" id="profile">
  <div class="card">
    <h2>Profile</h2>
    <p>Username: <span id="profileUsername"></span></p>
    <p>Age: <span id="profileAge"></span></p>
    <p>Verified: <span id="profileVerified"></span></p>
    <p>UID: <span id="profileUID"></span></p>
    <p>Created: <span id="profileCreated"></span></p>
    <p>Provider: <span id="profileProvider"></span></p>
    <p>Premium: <span id="profilePremium"></span></p>
    <p>Theme: <span id="profileTheme"></span></p>
    <p>Last Username Change: <span id="profileLastName"></span></p>
    <button onclick="closeModal(profile)">Close</button>
  </div>
</div>

<!-- SHOP -->
<div class="modal" id="shop">
  <div class="card">
    <h2>Shop</h2>
    <p>GameBox Premium ⭐</p>
    <button onclick="buyPremium()">Buy Premium</button>
    <button onclick="closeModal(shop)">Close</button>
  </div>
</div>

</body>
</html>
