<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>GameBox</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  EmailAuthProvider,
  reauthenticateWithCredential
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDulFQbzyizMXE1i7uBD5RVaR6bQa0SEfU",
  authDomain: "gamebox-681ef.firebaseapp.com",
  projectId: "gamebox-681ef"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let userData;

// üîê AUTH CHECK
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  currentUser = user;
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    const randomName = "user" + Math.floor(10000 + Math.random() * 90000);
    userData = {
      username: randomName,
      ageStatus: "<13",
      ageChecked: false,
      lastUsernameChange: 0
    };
    await setDoc(ref, userData);
  } else {
    userData = snap.data();
  }

  renderUser();
});

// üß† RENDER USER
function renderUser() {
  usernameText.textContent = userData.username;
  ageTag.textContent = userData.ageStatus;
  settingsUsername.textContent = userData.username;
  settingsEmail.textContent = currentUser.email;
  settingsAge.textContent = userData.ageStatus;
  settingsChecked.textContent = userData.ageChecked ? "‚úî Checked" : "‚ùå Not checked";

  if (userData.ageChecked) {
    ageBanner.style.display = "none";
  }
}

// üö™ LOGOUT
window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};

// ‚öô SETTINGS
window.openSettings = () => settings.style.display = "flex";
window.closeSettings = () => settings.style.display = "none";

// üë∂ AGE CHECK
window.startAgeCheck = () => {
  agePopup.style.display = "flex";
};

window.finishAgeCheck = async () => {
  const birth = new Date(birthdate.value);
  const age = (Date.now() - birth) / (1000 * 60 * 60 * 24 * 365);

  const newStatus = age >= 13 ? "13+" : "<13";

  await updateDoc(doc(db, "users", currentUser.uid), {
    ageStatus: newStatus,
    ageChecked: true
  });

  userData.ageStatus = newStatus;
  userData.ageChecked = true;

  agePopup.style.display = "none";
  renderUser();
};

// ‚úè USERNAME CHANGE
window.changeUsername = async () => {
  const newName = newUsername.value.trim();
  const password = confirmPassword.value;

  if (!newName || !password) return alert("Fehlende Daten");

  // Spezialregel
  if (
    (newName === "Crafii9" || newName === "Crafii9YT") &&
    currentUser.email !== "crafiii60@gmail.com"
  ) {
    return alert("Dieser Username ist reserviert.");
  }

  const now = Date.now();
  if (now - (userData.lastUsernameChange || 0) < 2592000000) {
    return alert("Username nur alle 30 Tage √§nderbar.");
  }

  const cred = EmailAuthProvider.credential(currentUser.email, password);
  await reauthenticateWithCredential(currentUser, cred);

  await updateDoc(doc(db, "users", currentUser.uid), {
    username: newName,
    lastUsernameChange: now
  });

  userData.username = newName;
  renderUser();
  alert("Username ge√§ndert!");
};
</script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #121218;
  color: white;
  display: flex;
}
.sidebar {
  width: 220px;
  background: #1c1c28;
  padding: 20px;
}
.sidebar img {
  width: 100%;
  margin-bottom: 20px;
}
.sidebar button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
}
.premium {
  background: gold;
  color: black;
  font-weight: bold;
}
.main {
  flex: 1;
}
.topbar {
  height: 60px;
  background: #1c1c28;
  display: flex;
  align-items: center;
  padding: 0 20px;
}
.topbar input {
  margin: auto;
  padding: 6px;
}
.user {
  margin-right: 10px;
}
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  justify-content: center;
  align-items: center;
}
.box {
  background: #1c1c28;
  padding: 20px;
  width: 400px;
}
.banner {
  background: #9333ea;
  padding: 10px;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<div class="sidebar">
  <img src="gamebox_logo1.png">
  <button>Homepage</button>
  <button>Profile</button>
  <button>Shop</button>
  <button class="premium">Premium</button>
</div>

<div class="main">
  <div class="topbar">
    <input placeholder="Suchen...">
    <div class="user">
      <span id="usernameText"></span>
      <small id="ageTag"></small>
    </div>
    <button onclick="openSettings()">...</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="popup" id="settings">
  <div class="box">
    <h2>Settings</h2>

    <div class="banner" id="ageBanner">
      Age verification required
      <button onclick="startAgeCheck()">Continue</button>
    </div>

    <p>Username: <span id="settingsUsername"></span></p>
    <p>Email: <span id="settingsEmail"></span></p>
    <p>Alter: <span id="settingsAge"></span> (<span id="settingsChecked"></span>)</p>

    <hr>
    <input id="newUsername" placeholder="Neuer Username">
    <input id="confirmPassword" type="password" placeholder="Passwort best√§tigen">
    <button onclick="changeUsername()">Username √§ndern</button>

    <hr>
    <button onclick="logout()">Logout</button>
    <button onclick="closeSettings()">Schlie√üen</button>
  </div>
</div>

<!-- AGE CHECK -->
<div class="popup" id="agePopup">
  <div class="box">
    <h3>Age Verification</h3>
    <input type="date" id="birthdate">
    <button onclick="finishAgeCheck()">Verify</button>
  </div>
</div>

</body>
</html>
